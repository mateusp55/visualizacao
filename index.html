<!DOCTYPE html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Evasão na Universidade Federal do Ceará</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>

   <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Source+Serif+Pro:ital,wght@0,300;0,600;1,600&display=swap" rel="stylesheet">

   <!-- Make sure you put this AFTER Leaflet's CSS -->
   <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/dc@4/dist/style/dc.css" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/crossfilter2@1.5.2/crossfilter.min.js"></script>
    <script src="https://unpkg.com/dc@4.0.5/dist/dc.min.js"></script>
  
    <style>
      body{
        font-family: 'Source Serif Pro', serif;
      }

      p{
        font-size: 20px;
        margin-bottom: 50px;
        margin-top: 50px;
      }
      .footer{
        position: relative;
        bottom: 0px;
        background-color: #000;
        padding: 50px;
        margin-top: 50px;
      }
      .footer p{
        color: #ccc;
        font-weight: bold;
        text-align: center;
      }
      h1{
        font-family: 'Dela Gothic One', cursive;
        font-size: 100px;
        margin-bottom: 100px;
        margin-top: 50px;
        z-index: 1;
      }
      h2{
        text-align: center;
        font-weight: bold;
      }
      .detalhe{
        position: absolute;
        right: 100px;
        top: -100px;
        z-index: 0;
      }
      .bg{
        width: 100%;
        height: 500px;
        background: rgb(205,255,98);
        background: linear-gradient(180deg, rgba(205,255,98,1) 0%, rgba(255,255,255,0) 100%);
        position: absolute;
        top:0;
      }
      .destaque{
        font-size: 40px;

      }
      #mapid {
        width: 650px;
        height: 480px;
        z-index: -50;
      }
      h4 span {
        font-size:14px;
        font-weight:normal;
      }

    </style>
</head>
<body>

  <div class="bg"></div>

  <main role="main" class="container">
    
    <div class="row">
      <h1> Evasão na Universidade Federal do Ceará</h1>
    </div>
  <div class="row justify-content-center">
    <div class="col-8">
      <p>A evasão é um problema que aflige as instituições de ensino em geral. Essa perda de alunos antes da conclusão do curso acontece por variados motivos e deve ser acompanhada pelas instituições para criar ações eficazes de minimização desses números. Dentro da Universidade Federal do Ceará (UFC), os números estão disponíveis para consulta e sevem não só como insumos para um planejamento efetivo mas também como prestação de contas com a sociedade. Nesta página apresentamos e discutimos os dados de evasão da UFC de 2015 a 2019.</p>
    </div>

    <div id="chart1" class="single-col">
      <h2>Taxa de evasão por ano</h2>
    </div>

    <div class="col-8">

      <p class="destaque">Lorem ipsum dolor sit amet, consectetur adipiscing elit. In tincidunt in libero sed viverra.</p>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. In tincidunt in libero sed viverra. Donec auctor, libero sed pharetra tincidunt, augue dui aliquet diam, nec aliquam sem dui id arcu. Quisque id sagittis felis, lobortis sagittis felis. Integer non bibendum turpis. Nulla neque ligula, fermentum ac nibh vitae, luctus viverra diam. Integer tortor leo, egestas ac orci in, condimentum suscipit augue. Ut pellentesque ipsum felis, sed hendrerit tortor rhoncus ut. Cras ornare dolor eget urna tincidunt pulvinar. Sed sed mauris maximus, rhoncus sem elementum, blandit quam. Vivamus vulputate aliquam dolor, sed ultricies ex rutrum nec.</p>
    </div>
    
  </div>

  <div class="row justify-content-center">
  <div id="chart2" class="single-col">
      <h2>Evasão por curso (TOP 10)</h2>
    </div>
  </div>

<div class="row justify-content-center">
    <div class="col-8">

      <p class="destaque">Lorem ipsum dolor sit amet, consectetur adipiscing elit. In tincidunt in libero sed viverra.</p>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. In tincidunt in libero sed viverra. Donec auctor, libero sed pharetra tincidunt, augue dui aliquet diam, nec aliquam sem dui id arcu. Quisque id sagittis felis, lobortis sagittis felis. Integer non bibendum turpis. Nulla neque ligula, fermentum ac nibh vitae, luctus viverra diam. Integer tortor leo, egestas ac orci in, condimentum suscipit augue. Ut pellentesque ipsum felis, sed hendrerit tortor rhoncus ut. Cras ornare dolor eget urna tincidunt pulvinar. Sed sed mauris maximus, rhoncus sem elementum, blandit quam. Vivamus vulputate aliquam dolor, sed ultricies ex rutrum nec.</p>
    </div>
    
  </div>


  <div class="row">
    <div class="col align-self-start" id="chart3">
      <h2>Evasão por origem escolar</h2>
    </div>
    <div class="col align-self-center" id="chart4">
      <h2>Evasão por gênero e faixa etária</h2>
    </div>
  </div>


<div class="row justify-content-center">
  <div class="col-8">

      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. In tincidunt in libero sed viverra. Donec auctor, libero sed pharetra tincidunt, augue dui aliquet diam, nec aliquam sem dui id arcu. Quisque id sagittis felis, lobortis sagittis felis. Integer non bibendum turpis. Nulla neque ligula, fermentum ac nibh vitae, luctus viverra diam. Integer tortor leo, egestas ac orci in, condimentum suscipit augue. Ut pellentesque ipsum felis, sed hendrerit tortor rhoncus ut. Cras ornare dolor eget urna tincidunt pulvinar. Sed sed mauris maximus, rhoncus sem elementum, blandit quam. Vivamus vulputate aliquam dolor, sed ultricies ex rutrum nec.</p>
    </div>
  </div>


  <div class="row justify-content-center">
  <div id="chart5" class="single-col">
      <h2>Evasão por quantidade de anos cursados</h2>
    </div>
  </div>

  


  </main>

<div class="footer">
  <p>Visualização de dados criada por Edilaine Santiago, Fausto Sampaio e Mateus Pinheiro.</br>
    Dados obtidos em <a href="#">lugar de onde foram tirados os dados</a>.
  </p>
</div>

<script type="text/javascript">
  var compositeChart = dc.compositeChart("#chart1");
  var rowChart = dc.rowChart("#chart2");
  var chart = dc.barChart("#chart3");

  var lineChart = dc.lineChart("#chart5");

  d3.csv('https://raw.githubusercontent.com/Fausto14/datavis/main/CENSO_2015_2019_UFC.csv').then( function (data) {

    // Run the data through crossfilter and load our 'facts'
      let facts = crossfilter(data);
      

    // FUNÇÕES
      function reduceAddEvadidos(p, v) {
      if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido')
       ++p;
      return p;
      }

      function reduceRemoveEvadidos(p, v) {
       if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido')
       --p;
       return p;
      }

      function reduceInitialEvadidos() {
        return 0;
      }


      function reduceAddTaxa(p, v) {
        if(v.SITUACAO === 'Desistente')
          ++p.desistentes;
        if(v.SITUACAO === 'Transferido')
          ++p.tranferidos;
        if(v.SITUACAO === 'Falecido')
          ++p.falecidos;

        if(v.ANO_CENSO === v.ANO_INGRESSO)
          ++p.ingressantes;

        p.taxa = (p.desistentes + p.tranferidos)/(p.ingressantes - p.falecidos) * 100;

        if((p.desistentes + p.tranferidos) === 0) p.taxa = 0;
        else
          if(((p.ingressantes - p.falecidos)) <= 0) p.taxa = 100;
        
        return p;
      }

      function reduceRemoveTaxa(p, v) {
         if(v.SITUACAO === 'Desistente')
          --p.desistentes;
         if(v.SITUACAO === 'Transferido')
          --p.tranferidos;
         if(v.SITUACAO === 'Falecido')
          --p.falecidos;

         if(v.ANO_CENSO === v.ANO_INGRESSO)
          --p.ingressantes;

        p.taxa = (p.desistentes + p.tranferidos)/(p.ingressantes - p.falecidos) * 100;

        if((p.desistentes + p.tranferidos) === 0) p.taxa = 0;
        else
          if(((p.ingressantes - p.falecidos)) <= 0) p.taxa = 100;
        
        return p;
      }

      function reduceInitialTaxa() {
        return {
          desistentes  : 0,
          tranferidos  : 0,
          ingressantes : 0,
          falecidos    : 0,
          taxa         : 0
        };
      }

      function sel_stack (i) {
       return d => d.value[i];
      }

      function reduceAddEvadidos2019(p, v) {
        if((v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido'))
          ++p;
        return p;
      }

      function reduceRemoveEvadidos2019(p, v) {
        if((v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido'))
          --p;
        return p;
      }

      function reduceInitialEvadidos2019() {
        return 0;
      }

      function getTops(source_group, k) {
    return {
        all: function () {
            return source_group.top(k);
        }
    };
}



 



    // DIMENSÕES
      let anoDim = facts.dimension(function (d){
        return d.ANO_CENSO;
     });

      let tipoEscolaDim = facts.dimension(function(d){
        return d.TP_ESCOLA_CONCLUSAO_ENS_MEDIO;
      });

      let tempoEvasaoDim = facts.dimension(function(d){
        return d.ANO_CENSO - d.ANO_INGRESSO;
      });

      let tempCrossfilter = crossfilter(tempoEvasaoDim.top(Infinity));

      let tempDimension = tempCrossfilter.dimension(function(d){
        return d.ANO_CENSO - d.ANO_INGRESSO;
      });

      let sitDim = facts.dimension(function(d){
        return d.NO_CURSO;
      });

      let generoDim = facts.dimension(function(d){
        return d.SEXO;
      });


    // GRUPOS
    let evadidosPorAnoGrupo = anoDim.group().reduce(reduceAddEvadidos, reduceRemoveEvadidos, reduceInitialEvadidos);
    let taxaEvasaoPorAnoGrupo = anoDim.group().reduce(reduceAddTaxa, reduceRemoveTaxa, reduceInitialTaxa);
    let evasaoOrigemAnoGrupo = anoDim.group().reduce((p, v) => {
                    if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido'){
                      ++p.total;
                      p.cPrivada += (v.TP_ESCOLA_CONCLUSAO_ENS_MEDIO === 'Privada' ? 1 : 0);
                      p.Privada = p.total ? p.cPrivada/p.total : 0;

                      p.cPublica += (v.TP_ESCOLA_CONCLUSAO_ENS_MEDIO === 'Publica' ? 1 : 0);
                      p.Publica = p.total ? p.cPublica/p.total : 0;

                      p['cSem resposta'] += (v.TP_ESCOLA_CONCLUSAO_ENS_MEDIO === 'Sem resposta' ? 1 : 0);
                      p['Sem resposta'] = p.total ? p['cSem resposta']/p.total : 0;
                    }
                    return p;
                }, (p, v) => {
                    if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido'){
                      --p.total;
                      p.cPrivada -= (v.TP_ESCOLA_CONCLUSAO_ENS_MEDIO === 'Privada' ? 1 : 0);
                      p.Privada = p.total ? p.cPrivada/p.total : 0;

                      p.cPublica -= (v.TP_ESCOLA_CONCLUSAO_ENS_MEDIO === 'Publica' ? 1 : 0);
                      p.Publica = p.total ? p.cPublica/p.total : 0;

                      p['cSem resposta'] -= (v.TP_ESCOLA_CONCLUSAO_ENS_MEDIO === 'Sem resposta' ? 1 : 0);
                      p['Sem resposta'] = p.total ? p['cSem resposta']/p.total : 0;
                    }
                    return p;
                }, () => {
                    return{
                      total: 0,
                      cPrivada: 0,
                      Privada: 0,
                      cPublica: 0,
                      Publica :0,
                      'cSem resposta' :0,
                      'Sem resposta': 0,
                    }
                });
    let evadidosTempoDeCursoGroup = tempoEvasaoDim.group().reduce((p, v) => {
                    if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido')
                      ++p;
                    return p;
                }, (p, v) => {
                    if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido')
                      --p;
                    return p;
                }, () => {
                  return 0;
                });

    let evasaoPorCursoGrupo2019 = sitDim.group().reduce(reduceAddEvadidos2019, reduceRemoveEvadidos2019, reduceInitialEvadidos2019);
    let evasaoPorCursoGrupo2019Top10 = getTops(evasaoPorCursoGrupo2019, 10);

    let evasaoGeneroGrupo = anoDim.group().reduce((p, v) => {
                    let ini = 16;
                    let step = 3;
                    let end = 49;
                    let until = 0;
                    for(var i=0; i<12; i++){
                      if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido'){
                        until = ini+step-1;
                        if(+v.IDADE >= ini && +v.IDADE <= until){
                          p[i].grupo = ini+' a '+until;
                          if(v.SEXO === 'Masculino') ++p[i].Masculino;
                          if(v.SEXO === 'Feminino')  ++p[i].Feminino;
                        }
                        if(+v.IDADE > (end-1) && ini == end){
                          p[i].grupo = '> '+(end-1);
                          if(v.SEXO === 'Masculino') ++p[i].Masculino;
                          if(v.SEXO === 'Feminino')  ++p[i].Feminino;
                        }
                        ini = ini + step;
                      }
                    }
                    return p;
                }, (p, v) => {
                    let ini = 16;
                    let step = 3;
                    let end = 49;
                    let until = 0;
                    for(var i=0; i<12; i++){
                      if(v.SITUACAO === 'Desistente' || v.SITUACAO === 'Transferido'){
                        until = ini+step-1;
                        if(+v.IDADE >= ini && +v.IDADE <= until){
                          p[i].grupo = ini+' a '+until;
                          if(v.SEXO === 'Masculino') --p[i].Masculino;
                          if(v.SEXO === 'Feminino')  --p[i].Feminino;
                        }
                        if(+v.IDADE > (end-1) && ini == end){
                          p[i].grupo = '> '+(end-1);
                          if(v.SEXO === 'Masculino') --p[i].Masculino;
                          if(v.SEXO === 'Feminino')  --p[i].Feminino;
                        }
                        ini = ini + step;
                      }
                    }
                    return p;
                }, () => {
                  return [
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                    {grupo : '', Masculino : 0, Feminino : 0},
                  ]
                });


    // ESCALAS
    let xAnoEvasao = d3.scaleLinear().domain([2015 - 0.5, 2019 + 0.5]);
    let xTotalEvasaoCurso = d3.scaleLinear().domain([0, evasaoPorCursoGrupo2019Top10.all()[0].value]);



    // EVASÃO POR ANO
  var ano_sel = '';
  
  compositeChart.width(900)
                .height(500)
                .margins({top: 80, right: 50, bottom: 40, left: 60})
                .clipPadding(40)
                .renderHorizontalGridLines(true)
                .shareTitle(false)
                .x(xAnoEvasao)
                .dimension(anoDim)
                .legend(dc.legend().x(20).y(10).itemHeight(13).gap(5))
                .brushOn(false)
                .elasticY(false)
                .compose([
                    dc.barChart(compositeChart)
                            .renderHorizontalGridLines(true)
                            .renderLabel(true)
                            .group(evadidosPorAnoGrupo, "Evadidos")
                            .brushOn(false)
                            .ordinalColors(['#cdff62'])
                            .elasticY(false)
                            .gap(50)
                            .centerBar(true),
                    dc.lineChart(compositeChart)
                            .renderLabel(true)
                            .elasticY(false)
                            .group(taxaEvasaoPorAnoGrupo, "Taxa de Evasão (%)")
                            .valueAccessor(function (d) {
                                return d.value.taxa;
                            })
                            .ordinalColors(['blue'])
                            .useRightYAxis(true)
                ])
                .yAxisLabel("Evadidos")
                .rightYAxisLabel("Taxa de Evasão (%)")
                .rightY(d3.scaleLinear().domain([0,100]))
                .on('renderlet', function (chart) {
                    chart.selectAll('.line')
                    .style('fill', 'none')
                    .style('stroke-width','3px');

                    chart.selectAll('.bar').on('click', function (e) {
                      
                      if($('#chart1 .bar.selected').length > 0){
                         $('#chart1 .bar').removeClass('selected');
                         $('#chart1 .bar').addClass('deselected');
                        
                         $(this).removeClass('deselected');
                         $(this).addClass('selected');
                      }
                      else{
                        $(this).addClass('selected');
                        $('#chart1 .bar').not(".selected").addClass('deselected');
                      }
                      
                      let ano = e.x;
                      
                      if(ano === ano_sel){
                        ano = null;
                        ano_sel = '';
                        $('#chart1 .bar').removeClass('selected').removeClass('deselected');
                      }
                      else{
                        ano_sel = ano;
                      }
                      
                      alert(ano);
                      anoDim.filter(ano);

                      //updatePyramidChart(ano);
                      //updateRadarChart();
                      //updateMarkers();
                      dc.redrawAll();
                    })
                });

  compositeChart.xAxis().ticks(5);
  compositeChart.xAxis().tickFormat(d3.format("d"));
  compositeChart.yAxis().tickFormat(d3.format("d"));


  // ROW CHART
  rowChart.width(900)
          .height(400)
          .dimension(sitDim)
          .group(evasaoPorCursoGrupo2019Top10, "Curso")
          .x(xTotalEvasaoCurso)
          .elasticX(true)
          .controlsUseVisibility(true)
          .gap(5)
          .ordinalColors(['#cdff62'])
          .on("filtered", function(chart, filter) {
              updateAllCharts();
          });

  rowChart.xAxis().tickFormat(d3.format("d"));


  
  


  //EVASÃO POR ORIGEM ESCOLAR
  var ano_sel = '';
  var escola_sel = '';
   chart.width(500)
        .height(400)
        .margins({top: 80, right: 50, bottom: 25, left: 60})
        .clipPadding(20)
        .renderHorizontalGridLines(true)
        .x(xAnoEvasao)
        //.x(d3.scaleLinear().domain([2015,2019]))
        .elasticY(true)
        .brushOn(false)
        .title(function (d) {
          return d.key + ' : ' + this.layer + ' : ' + ((d.value[this.layer]).toFixed(2)*100)+'%';
        })
        .dimension(anoDim)
        .group(evasaoOrigemAnoGrupo, 'Sem resposta', sel_stack('Sem resposta'))
        .gap(50)
        .centerBar(true)
        .renderLabel(false)
        .on("filtered", function(chart, filter) {
              updateMarkers()
          });

        chart.on('renderlet', function(chart) {
               chart.selectAll('.line')
                    .style('fill', 'none')
                    .style('stroke-width','3px');

                    chart.selectAll('.bar').on('click', function (e) {
                      
                      if($('#chart3 .bar.selected').length > 0){
                         $('#chart3 .bar').removeClass('selected');
                         $('#chart3 .bar').addClass('deselected');
                        
                         $(this).removeClass('deselected');
                         $(this).addClass('selected');
                      }
                      else{
                        $(this).addClass('selected');
                        $('#chart3 .bar').not(".selected").addClass('deselected');
                      }
                      
                      let ano = e.x;
                      let escola = e.layer;
                      console.log(escola)
                      
                      if(ano === ano_sel && escola === escola_sel){
                        ano = null;
                        ano_sel = '';
                        escola = null;
                        escola_sel = '';
                        $('#chart3 .bar').removeClass('selected').removeClass('deselected');
                      }
                      else{
                        ano_sel = ano;
                        escola_sel = escola;
                      }
                      
                      anoDim.filter(ano);
                      tipoEscolaDim.filter(escola);
                      updatePyramidChart(ano);
                      updateRadarChart();
                      updateMarkers();
                      dc.redrawAll();
                    })
                  
          });
  
        chart.legend(dc.legend().x(20).y(5).itemHeight(13).gap(5))
        
        chart.stack(evasaoOrigemAnoGrupo, 'Privada', sel_stack('Privada'));
        chart.stack(evasaoOrigemAnoGrupo, 'Publica', sel_stack('Publica'));

        chart.xAxis().ticks(5);
        chart.xAxis().tickFormat(d3.format("d"));
        chart.yAxis().tickFormat(d3.format(".0%"));
        chart.ordinalColors(['DarkGray','darkorange','blue']);




//PIRAMIDE 


function transformDataPyramide(data, ano = null){
  let saida = [];
  var temp = [];

  if(ano != null){
    data.forEach(function (d,i) {
      if(d.key == ano){
        d.value.forEach(function (o,j) {
          if(!temp[j]){
            temp[j] = {grupo: o.grupo, Masculino: o.Masculino, Feminino: o.Feminino};
          }
          else{
            temp[j].grupo = o.grupo;
            temp[j].Masculino += o.Masculino;
            temp[j].Feminino  += o.Feminino;
          }
        } ) 
      }
    })
  }
  else{
    data.forEach(function (d,i) {
      d.value.forEach(function (o,j) {
        if(!temp[j]){
          temp[j] = {grupo: o.grupo, Masculino: o.Masculino, Feminino: o.Feminino};
        }
        else{
          temp[j].grupo = o.grupo;
          temp[j].Masculino += o.Masculino;
          temp[j].Feminino  += o.Feminino;
        }
      } )
    })
  }
  return temp;
}

function pyramidChart(id, data){
  // SET UP DIMENSIONS
  var w = 600,
      h = 300;
      
  // margin.middle is distance from center line to each y-axis
  var margin = {
    top: 50,
    right: 20,
    bottom: 80,
    left: 20,
    middle: 28
  };
      
  // the width of each side of the chart
  var regionWidth = w/2 - margin.middle;
  
  // these are the x-coordinates of the y-axes
  var pointA = regionWidth,
      pointB = w - regionWidth;

  
  // GET THE TOTAL POPULATION SIZE AND CREATE A FUNCTION FOR RETURNING THE PERCENTAGE
  var totalPopulation = d3.sum(data, function(d) { return d.Masculino + d.Feminino; }),
      percentage = function(d) { return d / totalPopulation; };

  //remove svg old
  d3.select(id).select("svg").remove();
    
  // CREATE SVG
  var svg = d3.select(id).append('svg')
    .attr('width', margin.left + w + margin.right)
    .attr('height', margin.top + h + margin.bottom)
    // ADD A GROUP FOR THE SPACE WITHIN THE MARGINS
    .append('g')
      .attr('transform', translation(margin.left, margin.top));
  
  // find the maximum data value on either side
  //  since this will be shared by both of the x-axes
  var maxValue = Math.max(
    d3.max(data,  d => (d.Masculino)),
    d3.max(data,  d => (d.Feminino)),
  );
  
  // SET UP SCALES
    
  // the xScale goes from 0 to the width of a region
  //  it will be reversed for the left x-axis
  var xScale = d3.scaleLinear()
    .domain([0, maxValue])
    .rangeRound([0, regionWidth])
    .nice();
  
  var xScaleLeft = d3.scaleLinear()
    .domain([0, maxValue])
    .range([regionWidth, 0]);
  
  var xScaleRight = d3.scaleLinear()
    .domain([0, maxValue])
    .range([0, regionWidth]);
  
  var yScale = d3.scaleBand()
    .domain(data.map(d => d.grupo))
    .rangeRound([h,0], 0.1).padding(0.2);
  
  
  // SET UP AXES
  var yAxisLeft = d3.axisRight(yScale)
    .tickSize(6,0)
    .tickPadding(margin.middle-6);
  
  var yAxisRight = d3.axisLeft(yScale)
    .tickSize(6,0)
    .tickFormat('');
  
  var xAxisRight = d3.axisBottom(xScale)
    .ticks(5)
    .tickFormat(d3.format('d'));

  // REVERSE THE X-AXIS SCALE ON THE LEFT SIDE BY REVERSING THE RANGE
  var xAxisLeft = d3.axisBottom(xScale.copy().range([pointA, 0]))
    .ticks(5)
    .tickFormat(d3.format('d'));
  
  // MAKE GROUPS FOR EACH SIDE OF CHART
  // scale(-1,1) is used to reverse the left side so the bars grow left instead of right
  var leftBarGroup = svg.append('g')
    .attr('transform', translation(pointA, 0) + 'scale(-1,1)');
  var rightBarGroup = svg.append('g')
    .attr('transform', translation(pointB, 0));
  
  // DRAW AXES
  svg.append('g')
    .attr('class', 'axis y left')
    .attr('transform', translation(pointA, 0))
    .call(yAxisLeft)
    .selectAll('text')
    .style('font-size','10px')
    .style('text-anchor', 'middle');
  
  svg.append('g')
    .attr('class', 'axis y right')
    .attr('transform', translation(pointB, 0))
    .call(yAxisRight)
    .append("text")
    .attr("class", "axis-title")
    .attr("y", -35)
    .attr("dy", "1em")
    .attr("dx", "8px")
    .style('font-size','13px')
    .style("text-anchor", "end")
    .attr("fill", "#5D6971")
    .text("Faixa Etária");
  
  svg.append('g')
    .attr('class', 'axis x left')
    .attr('transform', translation(0, h))
    .call(xAxisLeft);
  
  svg.append('g')
    .attr('class', 'axis x right')
    .attr('transform', translation(pointB, h))
    .call(xAxisRight)
    .append("text")
    .attr("class", "axis-title")
    .attr("y", 40)
    .attr("dy", "1em")
    .attr("dx", "4em")
    .style('font-size','12px')
    .style("text-anchor", "end")
    .attr("fill", "#5D6971")
    .text("Quantidade de Evadidos");
  
  // DRAW BARS
  leftBarGroup.selectAll('.bar.left')
    .data(data)
    .enter().append('rect')
      .attr('class', 'bar left')
      .attr("fill","steelblue")
      .attr('x', 0)
      .attr('y', d => yScale(d.grupo))
      .attr('width', d => xScale((d.Masculino)))
      .attr('height', yScale.bandwidth())
    .on('mouseover', function (d,i){
      //Dim all blobs
      d3.selectAll(".bar.left")
        .transition().duration(200)
        .style("fill-opacity", 0.5); 
      //Bring back the hovered over blob
      d3.select(this)
        .transition().duration(200)
        .style("fill-opacity", 0.9);  
    })
    .on('mouseout', function(){
      //Bring back all blobs
      d3.selectAll(".bar.left")
        .transition().duration(200)
        .style("fill-opacity", 1);
    })
    .style('cursor','pointer')
    .append('title')
    .text((d,i) => d.grupo + " - Masculino : "+d.Masculino)
    .style("font-size","16px");
  
  rightBarGroup.selectAll('.bar.right')
    .data(data)
    .enter().append('rect')
      .attr('class', 'bar right')
      .attr("fill","darkorange")
      .attr('x', 0)
      .attr('y', d => yScale(d.grupo))
      .attr('width', d => xScale((d.Feminino)))
      .attr('height', yScale.bandwidth())
      .on('mouseover', function (d,i){
      //Dim all blobs
      d3.selectAll(".bar.right")
        .transition().duration(200)
        .style("fill-opacity", 0.5); 
      //Bring back the hovered over blob
      d3.select(this)
        .transition().duration(200)
        .style("fill-opacity", 0.9);  
      })
      .on('mouseout', function(){
        //Bring back all blobs
        d3.selectAll(".bar.right")
          .transition().duration(200)
          .style("fill-opacity", 1);
      })
      .style('cursor','pointer')
      .append('title')
      .text((d,i) => d.grupo + " - Feminino : "+d.Feminino)
      .style("font-size","16px");

  // exibindo as labels
  // leftBarGroup.selectAll('text') // Seleciona todos os text filhos de svg (nesse caso, uma seleção vazia)
  //   .data(data) // Vincula arrayOfNumbers com DOM elementos <text/>, produzindo seleções .enter(),.exit()
  //   .enter()// Retorna a parte dos dados que é nova ("entering") e ainda não está vinculada aos elementos DOM
  //     .append('text') // Para cada item de dado, adiciona um <text /> ao svg selecionado
  //     .attr('x', d => (-1 * xScale(d.Masculino)) - (10 * xScale(d.Masculino).toString().length + 5)) 
  //     .attr('y', (d, i) => yScale(d.grupo) + 13) // Configura a posição y de cada rótulo
  //     .attr("fill","steelblue")
  //     .style('font-family','Arial')
  //     .style('text-anchor','right')
  //     .style('font-size','13px')
  //     .style('font-weight','bold')
  //     .text(d => d.Masculino)
  //     .attr('transform', translation(0, 0) + 'scale(-1,1)');


  // rightBarGroup.selectAll('text') // Seleciona todos os text filhos de svg (nesse caso, uma seleção vazia)
  //   .data(data) // Vincula arrayOfNumbers com DOM elementos <text/>, produzindo seleções .enter(),.exit()
  //   .enter()// Retorna a parte dos dados que é nova ("entering") e ainda não está vinculada aos elementos DOM
  //     .append('text') // Para cada item de dado, adiciona um <text /> ao svg selecionado
  //     .attr('x', d => xScale(d.Feminino) + 5) // Configura a posição x de acordo com o índice do vetor
  //     .attr('y', (d, i) => yScale(d.grupo) + 13) // Configura a posição y de cada rótulo
  //     .attr("fill","darkorange")
  //     .style('font-family','Arial')
  //     .style('text-anchor','right')
  //     .style('font-size','13px')
  //     .style('font-weight','bold')
  //     .text(d => d.Feminino);
  
  
  // so sick of string concatenation for translations
  function translation(x,y) {
    return 'translate(' + x + ',' + y + ')';
  }

  svg.append("rect").attr("x",w - 100).attr("y",-40).attr("width", 10).attr("height", 10).style("fill", "steelblue");
  svg.append("rect").attr("x",w - 100).attr("y",-25).attr("width", 10).attr("height", 10).style("fill", "darkorange");
  svg.append("text").attr("x",w - 80).attr("y", -35).text("Masculino").style("font-size", "14px").attr("alignment-baseline","middle")
  svg.append("text").attr("x",w - 80).attr("y", -20).text("Feminino").style("font-size", "14px").attr("alignment-baseline","middle")

}


function updatePyramidChart(ano = null) {
  let dados = transformDataPyramide(evasaoGeneroGrupo.all(), ano)
  pyramidChart('#chart4', dados)
}

  let dados = transformDataPyramide(evasaoGeneroGrupo.all())
  pyramidChart("#chart4", dados);







        // EVASÃO POR ANOS CURSADOS
  lineChart.margins({top: 40, right: 50, bottom: 40, left: 80})
          .width(900)
          .height(400)
          .renderArea(true)
          .brushOn(true)
          .x(d3.scaleBand())
          //.x(d3.scaleLinear().domain([0,10]))
          .xUnits(dc.units.ordinal)
          .renderDataPoints(true)
          .clipPadding(40)
          .elasticY(true)
          .dimension(tempDimension)
          .group(evadidosTempoDeCursoGroup)
          .xAxisLabel('Anos cursados')
          .yAxisLabel('Quantidade de evadidos')
          .ordinalColors(['blue'])
          .title(function(d) {
              return "Anos de curso:  " + d.key + " ano(s)\n" +
                     "Quantidade de evadidos: "  + d.value;})
          .on('renderlet', function (chart) {
                    chart.selectAll('.line')
                    .style('fill', 'none')
                    .style('stroke-width','1px');
                })
          .on("filtered", function(chart, filter) {
              updateMarkers();
              updateRadarChart();
          });
          
  lineChart.xAxis().ticks(10);
  if(evadidosTempoDeCursoGroup.top(1)[0].value <= 10)
    lineChart.yAxis().ticks(evadidosTempoDeCursoGroup.top(1)[0].value);
  
  lineChart.xAxis().tickFormat(d3.format("d"));
  lineChart.yAxis().tickFormat(d3.format("d"));

    dc.renderAll();

});

</script>





<!-- Bootstrap javascript files -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        
</body>
</html>